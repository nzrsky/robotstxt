name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  # Build the C++ library and C bindings
  build-cpp:
    name: Build C++ Library
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Release, Debug]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Configure CMake
        run: cmake -B _build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

      - name: Build
        run: cmake --build _build --config ${{ matrix.build_type }}

      - name: Run C++ tests
        run: |
          cd _build
          ctest --output-on-failure -C ${{ matrix.build_type }}

      - name: Upload library artifacts
        uses: actions/upload-artifact@v4
        with:
          name: librobots-${{ matrix.os }}-${{ matrix.build_type }}
          path: |
            _build/librobots.*
            _build/*.dylib
            _build/*.so
          retention-days: 1

  # Python bindings tests
  test-python:
    name: Python Bindings
    needs: build-cpp
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: librobots-${{ matrix.os }}-Release
          path: _build

      - name: Set library permissions
        run: chmod +x _build/* || true

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run Python tests
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/_build
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/_build
          ROBOTS_LIB_PATH: ${{ github.workspace }}/_build
        run: |
          cd bindings/python
          python -m pytest test_robots.py -v

  # Go bindings tests
  test-go:
    name: Go Bindings
    needs: build-cpp
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        go-version: ['1.21', '1.22', '1.23']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: librobots-${{ matrix.os }}-Release
          path: _build

      - name: Set library permissions
        run: chmod +x _build/* || true

      - name: Install C++ runtime (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libstdc++6

      - name: Run Go tests
        env:
          CGO_LDFLAGS: "-L${{ github.workspace }}/_build -lrobots -lstdc++"
          CGO_CFLAGS: "-I${{ github.workspace }}/bindings/c"
          LD_LIBRARY_PATH: ${{ github.workspace }}/_build
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/_build
        run: |
          cd bindings/go
          go test -v ./...

  # Rust bindings tests
  test-rust:
    name: Rust Bindings
    needs: build-cpp
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, beta]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust ${{ matrix.rust }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: librobots-${{ matrix.os }}-Release
          path: _build

      - name: Set library permissions
        run: chmod +x _build/* || true

      - name: Run Rust tests
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/_build
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/_build
          RUSTFLAGS: "-L ${{ github.workspace }}/_build"
        run: |
          cd bindings/rust
          cargo test --verbose

  # Swift bindings tests - temporarily disabled due to Xcode/Swift version incompatibility
  # test-swift:
  #   name: Swift Bindings
  #   needs: build-cpp
  #   runs-on: macos-13
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Build and test Swift package
  #       run: |
  #         cd bindings/swift
  #         swift build
  #         swift test

  # Ruby bindings tests
  test-ruby:
    name: Ruby Bindings
    needs: build-cpp
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        ruby-version: ['3.1', '3.2', '3.3']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby-version }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: librobots-${{ matrix.os }}-Release
          path: _build

      - name: Set library permissions
        run: chmod +x _build/* || true

      - name: Install Ruby dependencies
        run: |
          gem install ffi minitest rake

      - name: Run Ruby tests
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/_build
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/_build
          ROBOTS_LIB_PATH: ${{ github.workspace }}/_build
        run: |
          cd bindings/ruby
          ruby test/test_robotstxt.rb

  # Java bindings tests
  test-java:
    name: Java Bindings
    needs: build-cpp
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        java-version: ['11', '17', '21']

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: librobots-${{ matrix.os }}-Release
          path: _build

      - name: Set library permissions
        run: chmod +x _build/* || true

      - name: Build JNI library
        run: |
          cd bindings/java/src/main/native
          if [ "$RUNNER_OS" == "Linux" ]; then
            g++ -shared -fPIC \
              -I"$JAVA_HOME/include" \
              -I"$JAVA_HOME/include/linux" \
              -I"${{ github.workspace }}/bindings/c" \
              robots_jni.cc \
              -L"${{ github.workspace }}/_build" \
              -Wl,-rpath,'$ORIGIN' \
              -Wl,--no-as-needed \
              -lrobots \
              -o librobots_jni.so
            cp librobots_jni.so ${{ github.workspace }}/_build/
          else
            clang++ -shared -fPIC \
              -I"$JAVA_HOME/include" \
              -I"$JAVA_HOME/include/darwin" \
              -I"${{ github.workspace }}/bindings/c" \
              robots_jni.cc \
              -L"${{ github.workspace }}/_build" \
              -Wl,-rpath,@loader_path \
              -lrobots \
              -lc++ \
              -o librobots_jni.dylib
            cp librobots_jni.dylib ${{ github.workspace }}/_build/
          fi

      - name: Run Java tests
        env:
          LD_LIBRARY_PATH: ${{ github.workspace }}/_build
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/_build
          ROBOTS_LIB_PATH: ${{ github.workspace }}/_build
        run: |
          cd bindings/java
          mvn test
