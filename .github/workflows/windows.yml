name: Windows CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build_type: [Release, Debug]

    steps:
      - uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -B _build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DROBOTS_BUILD_STATIC=OFF

      - name: Build
        run: cmake --build _build --config ${{ matrix.build_type }}

      - name: Run C++ tests
        run: |
          cd _build
          ctest --output-on-failure -C ${{ matrix.build_type }}

      - name: Upload library artifacts
        uses: actions/upload-artifact@v4
        with:
          name: librobots-windows-${{ matrix.build_type }}
          path: |
            _build/${{ matrix.build_type }}/robots.dll
            _build/${{ matrix.build_type }}/robots.lib
          retention-days: 1

  test-python-windows:
    name: Python Bindings (Windows)
    needs: build-windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: librobots-windows-Release
          path: _build

      - name: List downloaded files
        run: Get-ChildItem -Recurse _build

      - name: Copy DLLs to _build root
        run: |
          if (Test-Path "_build/Release") {
            Copy-Item "_build/Release/*" "_build/" -Force
          }

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run Python tests
        env:
          ROBOTS_LIB_PATH: ${{ github.workspace }}/_build
        run: |
          $env:PATH = "${{ github.workspace }}/_build;$env:PATH"
          cd bindings/python
          python -m pytest test_robots.py -v

  test-java-windows:
    name: Java Bindings (Windows)
    needs: build-windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: ['11', '17', '21']

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: librobots-windows-Release
          path: _build

      - name: List downloaded files
        run: Get-ChildItem -Recurse _build

      - name: Copy DLLs to _build root
        run: |
          if (Test-Path "_build/Release") {
            Copy-Item "_build/Release/*" "_build/" -Force
          }

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build JNI library
        run: |
          cd bindings/java/src/main/native
          cl /LD /EHsc /MD /I"$env:JAVA_HOME/include" /I"$env:JAVA_HOME/include/win32" /I"${{ github.workspace }}/bindings/c" robots_jni.cc /link /LIBPATH:"${{ github.workspace }}/_build" robots.lib /OUT:robots_jni.dll
          copy robots_jni.dll ${{ github.workspace }}/_build/

      - name: Run Java tests
        env:
          ROBOTS_LIB_PATH: ${{ github.workspace }}/_build
        run: |
          $env:PATH = "${{ github.workspace }}/_build;$env:PATH"
          cd bindings/java
          mvn test

  test-ruby-windows:
    name: Ruby Bindings (Windows)
    needs: build-windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        ruby-version: ['3.1', '3.2', '3.3']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby-version }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}

      - name: Download library artifact
        uses: actions/download-artifact@v4
        with:
          name: librobots-windows-Release
          path: _build

      - name: List downloaded files
        run: Get-ChildItem -Recurse _build

      - name: Copy DLLs to _build root
        run: |
          if (Test-Path "_build/Release") {
            Copy-Item "_build/Release/*" "_build/" -Force
          }

      - name: Install Ruby dependencies
        run: gem install ffi minitest rake

      - name: Run Ruby tests
        env:
          ROBOTS_LIB_PATH: ${{ github.workspace }}/_build
        run: |
          $env:PATH = "${{ github.workspace }}/_build;$env:PATH"
          cd bindings/ruby
          ruby test/test_robotstxt.rb
